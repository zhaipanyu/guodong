<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>项目详情页:模板</title>

    <!--bs-css-->
    <link href="lib/css/bootstrap.min.css" title="" rel="stylesheet" />
    <!--整体基本样式-->
    <link title="" href="src/css/style.css" rel="stylesheet" type="text/css" />
    <!--换肤-->
    <link title="blue" href="src/css/skin.css" rel="stylesheet" type="text/css" />

    <!--jq-js-->
    <script type="text/javascript" src="lib/js/jquery.min.js"></script>
    <!--bs-js-->
    <script type="text/javascript" src="lib/js/bootstrap.min.js"></script>

    <!--表格css-->
    <link rel="stylesheet" href="lib/css/bootstrap-table.css">

    <!--表格js-->
    <script src="lib/js/bootstrap-table.js"></script>
    <!--些表格显示信息才会被设置成中文-->
    <script src="lib/js/bootstrap-table-zh-CN.js"></script>
    <!--baiduapi-->
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=LqUOHyuUwsHDzZpOTrmb4fSxx257S8zt&s=1"></script>
    <style>
        .land-search-picture-wrap { 
            margin-left: 20px;
            display: none;
        }


        .photo-item .thumb img {
            width: 500px;
            height: 400px;
        }

        .photo-item .thumb {
            float: left;
        }

        #allmap {
            width: 450px;
            height: 400px;
            overflow: hidden;
            margin-left: 30px;
            font-family: "微软雅黑";
        }
    </style>
</head>


<body>
    <nav class="nav navbar-default navbar-mystyle navbar-fixed-top">
        <div class="navbar-header">
            <button class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse"> 
     <span class="icon-bar"></span> 
     <span class="icon-bar"></span> 
     <span class="icon-bar"></span> 
    </button>
            <a class="navbar-brand mystyle-brand"><span class="glyphicon glyphicon-home"></span></a> </div>
        <div class="collapse navbar-collapse">
            <ul class="nav navbar-nav">
                <li class="li-border"><a class="mystyle-color" href="#">管理控制台</a></li>
                </li>
            </ul>


            <ul class="nav navbar-nav pull-right">

                <li class="li-border dropdown"><a href="#" class="mystyle-color" data-toggle="dropdown">
      <span class="glyphicon glyphicon-search"></span> 搜索</a>
                    <div class="dropdown-menu search-dropdown">
                        <div class="input-group">
                            <input type="text" class="form-control">
                            <span class="input-group-btn">
                   <button type="button" class="btn btn-default">搜索</button>
                </span>
                        </div>
                    </div>
                </li>

                <li class="dropdown li-border">
                    <a href="#" class="dropdown-toggle mystyle-color" data-toggle="dropdown">605875855@qq.com
         <span class="caret"></span></a>
                    <ul class="dropdown-menu">
                        <li><a href="login.html">退出</a></li>
                        <li><a href="changepassword.html">修改密码</a></li>
                    </ul>
                </li>

            </ul>
        </div>
    </nav>

    <!--左侧-->
    <div class="down-main">
        <!--.left-full{ width:160px; display:block;}-->
        <!--左侧整个区-->
        <div class="left-main left-full">
            <!--左侧带菜单区-->
            <div class="subNavBox">
                <!--第一组-->
                <div class="sBox">
                    <!--subNav:就是项目按钮栏-->
                    <div class="subNav sublist-down">
                        <!--lyphicon-chevron-down 箭头朝下按钮,第一个项目默认展开子模块,且箭头朝下-->
                        <span class="title-icon glyphicon glyphicon-chevron-down"></span>
                        <span class="sublist-title">项目管理</span>
                    </div>
                    <!--内容是否展开,默认第一组之后是展开-->
                    <ul class="navContent">
                        <li>
                            <a href="projectList.html"><span class="sublist-icon glyphicon glyphicon-music"></span><span class="sub-title">项目列表</span></a></li>
                        <li>
                            <a href="#"><span class="sublist-icon glyphicon glyphicon-user"></span><span class="sub-title">项目派发</span></a></li>

                    </ul>
                </div>

                <!--第二组-->
                <div class="sBox">
                    <div class="subNav sublist-up">
                        <!--图标方向lyphicon-chevron-up 箭头朝上按钮-->
                        <span class="title-icon glyphicon glyphicon-chevron-up"></span>
                        <span class="sublist-title">施工管理</span></div>
                    <!--内容是否展开,默认第二组之后是收起:style="display: none;-->
                    <ul class="navContent" style="display: none;">
                        <li>
                            <a href="#"><span class="sublist-icon glyphicon glyphicon-user"></span><span class="sub-title">施工照片审核</span></a></li>
                        <li>
                            <a href="#"><span class="sublist-icon glyphicon glyphicon-user"></span><span class="sub-title">模施工照片确认</span></a></li>

                    </ul>
                </div>

                <!--第三组-->
                <div class="sBox">
                    <div class="subNav sublist-up">
                        <!--图标方向lyphicon-chevron-up 箭头朝上按钮-->
                        <span class="title-icon glyphicon glyphicon-chevron-up"></span>
                        <span class="sublist-title">项目三</span></div>
                    <!--内容是否展开,默认第二组之后是收起-->
                    <ul class="navContent" style="display: none;">
                        <li>
                            <a href="#"><span class="sublist-icon glyphicon glyphicon-user"></span><span class="sub-title">模块1</span></a></li>
                        <li>
                            <a href="#"><span class="sublist-icon glyphicon glyphicon-user"></span><span class="sub-title">模块2</span></a></li>

                    </ul>
                </div>


            </div>
            <!--class=subNavBox-->
        </div>

        <!--右侧内容-->
        <!--.right-full{ left:160px;}-->
        <div class="right-product right-full">

            <ol class="breadcrumb">
                <li class="active"><a href="#">项目管理</a></li>
                <li class="active"><a href="#">项目列表</a></li>
                <li>项目详情</li>
            </ol>


            <!--Tab-->
            <div>

                <!-- Nav tabs -->
                <ul class="nav nav-tabs" role="tablist">
                    <!-- 子tab -->
                    <li role="presentation" class=" active"><a href="#home" aria-controls="home" role="tab" data-toggle="tab">地质勘探</a></li>

                    <!-- 子tab:下拉菜单 -->
                    <li role="presentation" class="dropdown">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                            土建施工 <span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <!-- 子tab:下拉1 -->
                            <li role="presentation"><a href="#dropdown1" aria-controls="messages" role="tab" data-toggle="tab">落地塔基</a></li>
                            <!-- 子tab:下拉2 -->
                            <li role="presentation"><a href="#dropdown2" aria-controls="settings" role="tab" data-toggle="tab">落地机房</a></li>
                        </ul>
                    </li>


                    <!-- 必有的子tab -->
                    <li role="presentation"><a href="#profile" aria-controls="profile" role="tab" data-toggle="tab">塔桅安装</a></li>
                    <li role="presentation"><a href="#messages" aria-controls="messages" role="tab" data-toggle="tab">接电施工</a></li>
                    <li role="presentation"><a href="#settings" aria-controls="settings" role="tab" data-toggle="tab">配套安装</a></li>

                </ul>

                <!-- Tab 展开内容 -->
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="home">
                        <!--加入表格:地质勘探-->
                        <table id="land-search"></table>地质勘探
                        <div class="land-search-picture-wrap">
                            <ul class="pictures">

                            </ul>
                            <div id="allmap"></div>
                            <!-- <div class="photo-message"></div> -->
                        </div>

                    </div>
                    <div role="tabpanel" class="tab-pane " id="dropdown1">1落地塔基...
                        <!--加入表格:土建施工-落地塔基-->
                        <table id="land-tower"></table>
                    </div>
                    <div role="tabpanel" class="tab-pane " id="dropdown2">2落地机房...
                        <!--加入表格:土建施工-落地机房-->
                        <table id="land-machineroom"></table>
                    </div>

                    <!--下面三个流程都有-->
                    <div role="tabpanel" class="tab-pane" id="profile">塔桅安装..
                        <!--加入表格:塔桅安装-->
                        <table id="tower-install"></table>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="messages">接电施工..
                        <!--加入表格:接电施工-->
                        <table id="electric-build"></table>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="settings">配套安装.
                        <!--加入表格:配套安装-->
                        <table id="complement-install"></table>

                    </div>

                </div>
                <!-- Tab 展开内容结束 -->

            </div>
            <!--Tab结束-->


        </div>
        <!--.right-full-->


        <script type="text/javascript">
            //这是jQuery函数，是当文档载入完成的时候执行的，也就是说文档载入完成后执行
            $(function () {
                /*左侧导航栏显示隐藏功能*/
                //subNav:就是项目按钮栏
                $(".subNav").click(function () {
                    /*如果是显示,点击会隐藏模块*/
                    if ($(this).find("span:first-child").attr('class') ==
                        "title-icon glyphicon glyphicon-chevron-down") {
                        $(this).find("span:first-child").removeClass("glyphicon-chevron-down");
                        $(this).find("span:first-child").addClass("glyphicon-chevron-up");
                        $(this).removeClass("sublist-down");
                        $(this).addClass("sublist-up");
                    }
                    /*如果是隐藏,点击会显示模块*/
                    else {
                        $(this).find("span:first-child").removeClass("glyphicon-chevron-up");
                        $(this).find("span:first-child").addClass("glyphicon-chevron-down");
                        $(this).removeClass("sublist-up");
                        $(this).addClass("sublist-down");
                    }

                    /*当有一个项目的模块展开时,其他项目的模块要隐藏,还要把箭头的方向改过来.*/
                    // $(this).parent().siblings().find("ul").css("display", "none");

                    // 修改数字控制速度， slideUp(500)控制卷起速度
                    $(this).next(".navContent").slideToggle(100).siblings(".navContent").slideUp(100);
                })
            })


            //加载表格
            $(document).ready(function () {
                //获取请求数据需要的参数:proj_code
                var SearchUrl = function () {
                    // var str = "projectDetail.html?listId=GDJZ2014001620LT";
                    var UrlStr = window.location.href;
                    var reg = /\?listId=/g;
                    var index = UrlStr.search(reg); //18
                    var newStr = UrlStr.slice(index + 8, index + 8 + 16);
                    // console.log('newStr:' + newStr);
                    return newStr;
                }
                var projectCode = SearchUrl();


                //ajax封装
                function wrpAjax(str, data, fn) {

                    $.ajax({
                        url: "http://120.27.216.49:2112/api/" + str,
                        headers: {
                            'Content-Type': 'text/plain charset=UTF-8',
                            'dev-request-type': 'user_web',
                        },
                        type: 'post',
                        dataType: 'json',
                        processData: false,
                        data: JSON.stringify({
                            params: $.extend({
                                limt: 10,
                                offset: 0
                            }, data)
                        })
                    }).done(function (res) {
                        fn(res);
                    }).fail(function () {
                        alert('error');
                    })
                }
                //调用方法
                wrpAjax('projectLink_get', {
                    proj_code: projectCode
                }, function (data) {
                    getPictureDate(data);

                });

                //展示图片
                var getPictureDate = function (data) {
                    var htmls = '';
                    //arr包含多张图片对象,拍摄信息
                    // var locationArray = [];//sub[0]是第一个流程,sub[1]是第二个,暂时固定这2个流程
                    var photoArray = data.result.detail[0].sub[0].proj_link_pic; //数组:照片信息
                    // console.log(photoArray);
                    for (var i = 0; i < photoArray.length; i++) {
                        var pictureUrl = photoArray[i].pic; //图片url
                        htmls += '<li class="photo-item">';
                        htmls += '<div class="photo-message">'
                        htmls += '<p>' + '用户设备:' + photoArray[i].dev_info + '</p>';
                        htmls += '<p>' + '拍摄时间:' + photoArray[i].time + '</p>';
                        htmls += '<p>' + 'user_code:' + photoArray[i].user_code + '</p>';
                        htmls += '<p>' + 'user_name:' + photoArray[i].user_name + '</p>';
                        htmls += '</div>'
                        htmls += '<a href="#">';
                        htmls += '<div class="thumb"> <img src="' + pictureUrl + '"></div>';
                        htmls += '</a></li>';
                        // console.log(htmls);
                        // 百度地图API功能
                        var map = new BMap.Map("allmap"); // 创建Map实例
                        map.centerAndZoom(new BMap.Point(photoArray[i].localtion.lon, photoArray[i].localtion
                            .lat), photoArray[i].localtion.alt); // 初始化地图,设置中心点坐标和地图级别
                        map.enableScrollWheelZoom(true); //开启鼠标滚轮缩放   
                    }
                    $('.pictures').append(htmls);
                }

              
                //地质勘探-请求参数
                var queryParams = function (params) {
                    var param = {
                        proj_code: projectCode
                    };
                    return JSON.stringify({
                        params: $.extend({ //固定带上分页请求,先不管
                                limit: 10,
                                offset: 0
                            },
                            param
                        )
                    });
                }
                //地质勘探-请求体
                var responseHandler = function (e) {
                    //所有详情数据
                    if (e.result.detail && e.result.detail[0].name === '地质勘探') {
                        return {
                            "rows": e.result.detail[0].sub,
                            //表格底部显示总共多少条
                            "total": e.result.detail[0].sub.length
                        };
                    } else {
                        return {
                            "rows": [],
                            "total": 0
                        };
                    }
                } //responseHandler





                //点击项目名跳转
                var projectNameClick = function (value, row, index) {
                    // var html = '<a href="projectDetail.html' + '?listId=' + row.proj_code + '">' + value +"</a>";
                    return value;
                }


                //处理提交时间
                var projectLinkSubmitTimeClick = function (value) {
                    if (value === 0) {
                        return '-';
                    }
                    var date = new Date(value);
                    Y = date.getFullYear() + '-';
                    M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) +
                        '-';
                    D = date.getDate() + ' ';
                    return (Y + M + D);
                }

                // 处理表格里的图片的数据
                var projectLinkPictureClick = function (value, row, index) {
                    var html = '<a href="#">' + '审核' + "</a>";
                    return html;
                }


                //定义请求的方法

                var columns = [{
                        checkbox: true
                    },
                    {
                        field: 'proj_name',
                        title: '项目名称',
                        align: 'center',
                        formatter: projectNameClick, //自定义方法设置uid跳转链接
                        width: 250
                    },
                    {
                        field: 'proj_code',
                        title: '项目编码',
                        align: 'center',
                        sortable: false //本列不可以排序
                    },
                    {
                        // field: 'proj_link_pic',
                        title: '审核',
                        formatter: projectLinkPictureClick,
                    },
                    {
                        field: 'proj_link_submit_user_code',
                        title: '提交用户编码',
                        align: 'center'
                    },
                    {
                        field: 'proj_type_name',
                        title: '项目类型',
                        align: 'center'
                    },
                    {
                        field: 'proj_link_name',
                        title: 'proj_link_name',
                        align: 'center'
                    },
                    {
                        field: 'proj_link_describe',
                        title: '审核状态',
                        align: 'center',
                        width: 70
                    },
                    {
                        field: 'proj_module_name',
                        title: '模块名',
                        align: 'center'
                    },
                    {
                        field: 'name',
                        title: 'name',
                        align: 'center',
                        width: 100
                    },
                    {
                        field: 'proj_link_submit_time',
                        title: '提交时间',
                        align: 'center',
                        formatter: projectLinkSubmitTimeClick,
                    },

                ];
                //地质勘探表格
                $('#land-search').empty();
                $('#land-search').bootstrapTable('destroy').bootstrapTable({
                    url: 'http://120.27.216.49:2112/api/projectLink_get', //url一般是请求后台的url地址,调用ajax获取数据。此处我用本地的json数据来填充表格。
                    method: "post", //使用get请求到服务器获取数据
                    ajaxOptions: { //添加请求头部信息方法
                        headers: {
                            'Content-Type': 'text/plain charset=UTF-8',
                            'dev-request-type': 'user_web',
                        },
                    },
                    dataType: "json",
                    contentType: 'text/plain charset=UTF-8',
                    // toolbar: "#toolbar", //一个jQuery 选择器，指明自定义的toolbar, 这里#toolbar为了把搜索框放入toolbar
                    // uniqueId: "id", //每一行的唯一标识，一般为主键列
                    // height: document.body.clientHeight , //动态获取高度值，可以使表格自适应页面
                    cache: false, // 不缓存
                    striped: true, // 隔行加亮
                    // queryParamsType: "limit", //设置为"undefined",可以获取pageNumber，pageSize，searchText，sortName，sortOrder 
                    //设置为"limit",符合 RESTFul 格式的参数,可以获取limit, offset, search, sort, order 
                    queryParams: queryParams,
                    sidePagination: "server", //分页方式：client客户端分页，server服务端分页（*）
                    // sortable: true,                     //是否启用排序;意味着整个表格都会排序
                    // sortName: 'uid', // 设置默认排序为 name
                    // sortOrder: "asc", //排序方式
                    pagination: true, //是否显示分页（*）
                    // search: true, //是否显示表格搜索，此搜索是客户端搜索，不会进服务端，个人感觉意义不大,设置为 true时，按回车触发搜索方法
                    strictSearch: true, //设置为 true启用 全匹配搜索，否则为模糊搜索
                    // detailView:true,//可以显示详细页面模式
                    showColumns: true, //是否显示所有的列
                    showRefresh: true, //是否显示刷新按钮
                    showToggle: true, //是否显示详细视图和列表视图
                    clickToSelect: true, //是否启用点击选中行
                    minimumCountColumns: 2, //最少允许的列数 clickToSelect: true, //是否启用点击选中行
                    pageNumber: 1, //初始化加载第一页，默认第一页
                    pageSize: 10, //每页的记录行数（*）
                    pageList: [10, 25, 50, 100], //可供选择的每页的行数（*）
                    paginationPreText: "上一页",
                    paginationNextText: "下一页",
                    paginationFirstText: "First",
                    paginationLastText: "Last",
                    responseHandler: responseHandler, //处理返回的数据
                    onClickRow:  function (row, $element,field){
                        console.log(row)
                        if(row.proj_link_id == 10665 ){//"钻孔照片"
                        $('.land-search-picture-wrap').css('display','block');

                        }else if(row.proj_link_id == 10666){//"取土样照片"
                         $('.land-search-picture-wrap').css('display','none');
                         
                        }
                    },
                    columns: columns,
                    // dataAdvancedSearch:true,暂时没有
                    // dataTdTable:advancedTable,
                    onLoadSuccess: function (data) { //加载成功时执行
                        console.log('success');
                    },
                    onLoadError: function (res) { //加载失败时执行
                        console.log(res + 'error');
                    }
                }); //bootstrapTable方法结束



            }); // $(document).ready结束
        </script>
</body>

</html>